<meta charset="UTF-8">
<canvas id="gc"></canvas>
<script>

const gravity = 9.0;
const spriteWidth = 70;
const spriteHeight = 70;

let playerx = playery = 200;
let xvelocity = yvelocity = 0;
let onGround = holdLeft = holdRight = false;
let platforms = [];
let bullets = [];
let goal = {};
let enemies = [];
let playerDirection = 'right'
let framex = 0;
let framey = 0;
let spriteframe = 0;
const totalPlatforms = 40;
let playerImage = new Image();

playerImage.src = 'player.png';

window.onload = function() {
    canvas=document.getElementById('gc');
    canvas.setAttribute('width', window.innerWidth - 8);
    canvas.setAttribute('height', window.innerHeight - 25);
    context=canvas.getContext('2d');
    setInterval(update, 1000 / 30);
    document.addEventListener('keyup', keyUp);
    document.addEventListener('keydown', keyDown);

    goal = {
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      w: 40,
      h: 60
    }

    enemies.push({
        x: playerx + 200,
        y: playery - spriteWidth / 2,
        r: 20
    });

    for (i = 0; i < totalPlatforms; i++) {
        platforms.push({
            x:Math.random() * canvas.width,
            y:Math.random() * canvas.height,
            w:Math.random() * 100 + 50,
            h:Math.random() * 30 + 30
        });
    }
}

function update() {
    playerx += xvelocity;
    playery += yvelocity;

    if (onGround) {
        xvelocity *= 0.8; 
        framey = 0;
    } else {
        yvelocity += 1.1;
        xvelocity *= 0.99;
        framex = 0;
        framey = 2;
    }
    
    //goal touch action
    if (playerx + spriteWidth / 2 >= goal.x - 5 &&
        playerx - spriteWidth / 2 <= goal.x + 5 && 
        playery + spriteHeight / 2 >= goal.y + 10 &&
        playery - spriteHeight / 2 <= goal.y - 10) {
            alert('You Win! Generate next level?');
            location = location;
        }

    if (playery > window.innerHeight) {
        xvelocity = yvelocity = 0;
        playerx = playery = 200;
    }

    if (playerx < 0) {
        playerx = window.innerWidth - 8;
    }

    if (playerx > window.innerWidth - 8) {
        playerx = 0;
    }
    
    onGround=false;

    for (i = 0; i < totalPlatforms; i++) {
        if (
            playerx > platforms[i].x - 20 && 
            playerx < platforms[i].x + platforms[i].w + 20 &&
            playery > platforms[i].y &&
            playery < platforms[i].y + platforms[i].h 
        ) {
            playery=platforms[i].y;
            onGround = true;

            if (holdRight) {
                xvelocity += 1.5;
                framey=0;

                if (framex < 3) {
                    framex++;
                } else framex = 1;
            }

            if (holdLeft) {
                xvelocity -= 1.5;
                framey=1;

                if (framex < 3) {
                    framex++;
                } else framex = 1
            }
        }
    }

    // draw background
    context.fillStyle = 'white';
    context.fillRect(
        0,
        0,
        canvas.width,
        canvas.height
    );

    // draw player sprite
    context.drawImage(
        playerImage,
        framex * spriteWidth,
        framey * spriteHeight,
        spriteWidth, 
        spriteHeight,
        playerx + spriteWidth / 2,
        playery,
        -spriteWidth,
        -spriteHeight
    )

    //todo on-screen controlls

    // draw level goal
    context.fillStyle = 'orange';
    context.fillRect(
        goal.x - 20,
        goal.y - 40,
        goal.w,
        goal.h
    );
    
    // draw enemy that follows playery
    if (enemies.length) {
    context.beginPath();
    context.arc(
        playerx + 200,
        playery - spriteWidth / 2,
        20,
        0,
        2 * Math.PI
    );
    context.fillStyle = 'red';
    context.fill();
    }
    // draw platforms
    for (i = 0; i < totalPlatforms; i++) {
        context.lineWidth = 2;
        context.strokeStyle='black';
        context.strokeRect(
            platforms[i].x,
            platforms[i].y,
            platforms[i].w,
            platforms[i].h
        );
    }

    // draw lava floor
    context.fillStyle = "red";
    context.fillRect(
        0,
        canvas.height - 10,
        canvas.width,
        canvas.height + 4
    );

    //draw bullets if any are pushed to their array
    for (var i = 0; i < bullets.length; i++) {
        context.fillStyle = 'black';
        context.fillRect(
            bullets[i][0],
            bullets[i][1],
            bullets[i][3],
            bullets[i][2]
        )
    }

    for (var i = 0; i < bullets.length; i++) {
        if (bullets[i][0] > -11) {
            if (bullets[i][4] == 'right') { 
                bullets[i][0] += 20; 
            }

            if (bullets[i][4] == 'left') { 
                bullets[i][0] -= 20;
            }
        } 

        if (bullets[i][0] < -10 || bullets[i][0] > window.innerWidth-8) {	
            bullets.splice(i, 1);
        }
        //kill enemy action
        if (bullets && bullets[i][0] >= enemies[0].x) {
            enemies = [];
        }
        
    }
}

function keyDown(evt) {
    switch(evt.keyCode) {
        case 32: //space bar
            if (bullets.length <= 2) bullets.push([
                playerx,
                playery - 50,
                4,
                20,
                playerDirection
            ]);
        break;

        case 37: //left arrow key
            holdLeft=true;
            playerDirection = 'left';
        break;

        case 38: //up arrow key
            if(onGround) {
                yvelocity = -12;
                framex = 0;
                framey = 2;
            }
        break;

        case 39: //right arrow key
            holdRight=true;
            playerDirection = 'right';
        break;
    }
}

function keyUp(evt) {
    switch(evt.keyCode) {
        case 37:
            holdLeft=false;
            framex = 0;
        break;

        case 38:
            if(yvelocity<-3) {
                yvelocity = -3;
            }
        break;

        case 39:
            holdRight=false;
            framex = 0;
        break;
    }
}
</script>

